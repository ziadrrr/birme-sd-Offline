!function(){"use strict";var s={};function p(t,e,i,r){if(e.x>i||i>=e.x+e.width||e.y>r||r>=e.y+e.height)return t.outsideImportance;i=(i-e.x)/e.width,r=(r-e.y)/e.height;var a=2*n(.5-i),e=2*n(.5-r),i=Math.max(a-1+t.edgeRadius,0),r=Math.max(e-1+t.edgeRadius,0),i=(i*i+r*r)*t.edgeWeight,r=1.41-w(a*a+e*e);return t.ruleOfThirds&&(r+=1.2*Math.max(0,r+i+.5)*(o(a)+o(e))),r+i}function y(t,e,i){this.width=t,this.height=e,this.data=i?new Uint8ClampedArray(i):new Uint8ClampedArray(t*e*4)}function g(t,e){for(var i=t.data,r=t.width,a=Math.floor(t.width/e),n=Math.floor(t.height/e),t=new y(a,n),o=t.data,h=1/(e*e),s=0;s<n;s++)for(var d=0;d<a;d++){for(var u=4*(s*a+d),g=0,c=0,f=0,l=0,p=0,w=0,m=0;m<e;m++)for(var v=0;v<e;v++){var x=4*((s*e+m)*r+(d*e+v));g+=i[x],c+=i[1+x],f+=i[2+x],l+=i[3+x],p=Math.max(p,i[x]),w=Math.max(w,i[1+x])}o[u]=g*h*.5+.5*p,o[1+u]=c*h*.7+.3*w,o[2+u]=f*h,o[3+u]=l*h}return t}function e(t,e){var i=document.createElement("canvas");return i.width=t,i.height=e,i}function a(a){return{open:function(t){var e=t.naturalWidth||t.width,i=t.naturalHeight||t.height,e=a(e,i),i=e.getContext("2d");return!t.naturalWidth||t.naturalWidth==t.width&&t.naturalHeight==t.height?(e.width=t.width,e.height=t.height):(e.width=t.naturalWidth,e.height=t.naturalHeight),i.drawImage(t,0,0),s.Promise.resolve(e)},resample:function(t,i,r){return Promise.resolve(t).then(function(t){var e=a(~~i,~~r);return e.getContext("2d").drawImage(t,0,0,t.width,t.height,0,0,e.width,e.height),s.Promise.resolve(e)})},getData:function(t){return Promise.resolve(t).then(function(t){var e=t.getContext("2d").getImageData(0,0,t.width,t.height);return new y(t.width,t.height,e.data)})}}}s.Promise="undefined"!=typeof Promise?Promise:function(){throw new Error("No native promises and smartcrop.Promise not set.")},s.DEFAULTS={width:0,height:0,aspect:0,cropWidth:0,cropHeight:0,detailWeight:.2,skinColor:[.78,.57,.44],skinBias:.01,skinBrightnessMin:.2,skinBrightnessMax:1,skinThreshold:.8,skinWeight:1.8,saturationBrightnessMin:.05,saturationBrightnessMax:.9,saturationThreshold:.4,saturationBias:.2,saturationWeight:.1,scoreDownSample:8,step:8,scaleStep:.1,minScale:1,maxScale:1,edgeRadius:.4,edgeWeight:-20,outsideImportance:-.5,boostWeight:100,ruleOfThirds:!0,prescale:!0,imageOperations:null,canvasFactory:e,debug:!1},s.crop=function(t,e,n){var o=c({},s.DEFAULTS,e);o.aspect&&(o.width=o.aspect,o.height=1),null===o.imageOperations&&(o.imageOperations=a(o.canvasFactory));var i,r=o.imageOperations,h=1;return r.open(t,o.input).then(function(t){return o.width&&o.height&&(i=f(t.width/o.width,t.height/o.height),o.cropWidth=~~(o.width*i),o.cropHeight=~~(o.height*i),o.minScale=f(o.maxScale,l(1/i,o.minScale)),!1!==o.prescale&&((h=f(l(256/t.width,256/t.height),1))<1?(t=r.resample(t,t.width*h,t.height*h),o.cropWidth=~~(o.cropWidth*h),o.cropHeight=~~(o.cropHeight*h),o.boost&&(o.boost=o.boost.map(function(t){return{x:~~(t.x*h),y:~~(t.y*h),width:~~(t.width*h),height:~~(t.height*h),weight:t.weight}}))):h=1)),t}).then(function(t){return r.getData(t).then(function(t){for(var t=function(t,e){var i={},r=new y(e.width,e.height);(function(t,e){for(var i,r=t.data,a=e.data,n=t.width,o=t.height,h=0;h<o;h++)for(var s=0;s<n;s++){var d=4*(h*n+s);i=0===s||n-1<=s||0===h||o-1<=h?v(r,d):4*v(r,d)-v(r,d-4*n)-v(r,d-4)-v(r,4+d)-v(r,d+4*n),a[1+d]=i}})(e,r),function(t,e,i){for(var r=e.data,a=i.data,n=e.width,o=e.height,h=0;h<o;h++)for(var s=0;s<n;s++){var d=4*(h*n+s),u=m(r[d],r[1+d],r[2+d])/255,g=function(t,e,i,r){var a=w(e*e+i*i+r*r),e=e/a-t.skinColor[0],i=i/a-t.skinColor[1],t=r/a-t.skinColor[2];return 1-w(e*e+i*i+t*t)}(t,r[d],r[1+d],r[2+d]),c=g>t.skinThreshold,u=u>=t.skinBrightnessMin&&u<=t.skinBrightnessMax;a[d]=c&&u?(g-t.skinThreshold)*(255/(1-t.skinThreshold)):0}}(t,e,r),function(t,e,i){for(var r=e.data,a=i.data,n=e.width,o=e.height,h=0;h<o;h++)for(var s=0;s<n;s++){var d=4*(h*n+s),u=m(r[d],r[1+d],r[2+d])/255,g=function(t,e,i){var r=l(t/255,e/255,i/255),e=f(t/255,e/255,i/255);if(r===e)return 0;i=r-e;return.5<(r+e)/2?i/(2-r-e):i/(r+e)}(r[d],r[1+d],r[2+d]),c=g>t.saturationThreshold,u=u>=t.saturationBrightnessMin&&u<=t.saturationBrightnessMax;a[2+d]=u&&c?(g-t.saturationThreshold)*(255/(1-t.saturationThreshold)):0}}(t,e,r),function(t,e){if(t.boost){for(var i=e.data,r=0;r<e.width;r+=4)i[r+3]=0;for(r=0;r<t.boost.length;r++)!function(t,e){for(var i=e.data,r=e.width,a=~~t.x,n=~~(t.x+t.width),e=~~t.y,o=~~(t.y+t.height),h=255*t.weight,s=e;s<o;s++)for(var d=a;d<n;d++)i[3+4*(s*r+d)]+=h}(t.boost[r],e)}}(t,r);for(var a=g(r,t.scoreDownSample),n=-1/0,o=null,h=function(t,e,i){for(var r=[],a=f(e,i),n=t.cropWidth||a,o=t.cropHeight||a,h=t.maxScale;h>=t.minScale;h-=t.scaleStep)for(var s=0;s+o*h<=i;s+=t.step)for(var d=0;d+n*h<=e;d+=t.step)r.push({x:d,y:s,width:n*h,height:o*h});return r}(t,e.width,e.height),s=0,d=h.length;s<d;s++){var u=h[s];u.score=function(t,e,i){for(var r={detail:0,saturation:0,skin:0,boost:0,total:0},a=e.data,n=t.scoreDownSample,o=1/n,h=e.height*n,s=e.width*n,d=e.width,u=0;u<h;u+=n)for(var g=0;g<s;g+=n){var c=4*(~~(u*o)*d+~~(g*o)),f=p(t,i,g,u),l=a[1+c]/255;r.skin+=a[c]/255*(l+t.skinBias)*f,r.detail+=l*f,r.saturation+=a[2+c]/255*(l+t.saturationBias)*f,r.boost+=a[3+c]/255*f}return r.total=(r.detail*t.detailWeight+r.skin*t.skinWeight+r.saturation*t.saturationWeight+r.boost*t.boostWeight)/(i.width*i.height),r}(t,a,u),u.score.total>n&&(n=(o=u).score.total)}i.topCrop=o,t.debug&&o&&(i.crops=h,i.debugOutput=r,i.debugOptions=t,i.debugTopCrop=c({},i.topCrop));return i}(o,t),e=t.crops||[t.topCrop],i=0,r=e.length;i<r;i++){var a=e[i];a.x=~~(a.x/h),a.y=~~(a.y/h),a.width=~~(a.width/h),a.height=~~(a.height/h)}return n&&n(t),t})})},s.isAvailable=function(t){if(!s.Promise)return!1;t=t?t.canvasFactory:e;if(t===e&&!document.createElement("canvas").getContext("2d"))return!1;return!0},s.importance=p,s.ImgData=y,s._downSample=g,s._canvasImageOperations=a;var f=Math.min,l=Math.max,n=Math.abs,w=Math.sqrt;function c(t){for(var e=1,i=arguments.length;e<i;e++){var r=arguments[e];if(r)for(var a in r)t[a]=r[a]}return t}function o(t){return t=16*((t-1/3+1)%2*.5-.5),Math.max(1-t*t,0)}function m(t,e,i){return.5126*i+.7152*e+.0722*t}function v(t,e){return m(t[e],t[e+1],t[e+2])}"undefined"!=typeof define&&define.amd&&define(function(){return s}),"undefined"!=typeof exports?exports.smartcrop=s:"undefined"!=typeof navigator&&(window.SmartCrop=window.smartcrop=s),"undefined"!=typeof module&&(module.exports=s)}();